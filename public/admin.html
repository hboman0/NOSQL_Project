<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Taste-Mart | Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .admin-card {
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    .admin-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .stat-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 1rem;
    }
    .stat-box h3 {
      margin: 0;
      font-size: 2rem;
      font-weight: bold;
    }
    .stat-box p {
      margin: 0.5rem 0 0 0;
      opacity: 0.9;
    }
    .action-btn {
      padding: 1rem 2rem;
      font-size: 1.1rem;
      border-radius: 10px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <img src="images/logo.png" alt="logo" height="40"> Taste-Mart
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <button id="themeToggle" class="btn btn-outline-warning ms-3">üåô</button>
      <button 
        class="btn btn-outline-warning ms-2"
        data-bs-toggle="modal"
        data-bs-target="#loginModal"
        id="loginBtn">
        Login
      </button>
      <button 
        class="btn btn-outline-danger ms-2 d-none"
        id="logoutBtn">
        Logout
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
          <li class="nav-item"><a href="menu.html" class="nav-link">Menu</a></li>
          <li class="nav-item"><a href="reservation.html" class="nav-link">Reservation</a></li>
          <li class="nav-item"><a href="about.html" class="nav-link">About</a></li>
          <li class="nav-item"><a href="contact.html" class="nav-link">Contact</a></li>
          <li class="nav-item"><a href="admin.html" class="nav-link active">Admin</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <header class="text-center py-5 bg-light">
    <div class="container">
      <h1 class="display-5"><i class="fas fa-user-shield me-2"></i>Admin Panel</h1>
      <p class="lead">Advanced Operations & Analytics</p>
    </div>
  </header>

  <section class="py-5">
    <div class="container">
      
      <!-- Stats Section -->
      <div class="row mb-5">
        <div class="col-12">
          <div class="admin-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h3><i class="fas fa-chart-line me-2"></i>Reservation Statistics by Date</h3>
              <button class="btn btn-primary action-btn" id="loadStatsBtn">
                <i class="fas fa-sync-alt me-2"></i>Load Statistics
              </button>
            </div>
            
            <div id="statsContainer">
              <p class="text-muted text-center py-4">
                <i class="fas fa-info-circle me-2"></i>
                Click "Load Statistics" to view aggregation data
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Bulk Operations Section -->
      <div class="row mb-5">
        <div class="col-12">
          <div class="admin-card p-4">
            <h3 class="mb-4"><i class="fas fa-tasks me-2"></i>Bulk Operations</h3>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Mark Large Reservations:</strong> This operation uses MongoDB's 
              <code>updateMany()</code> to automatically flag all reservations with 6+ guests 
              as "Large group reservation".
            </div>

            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h5>Update All Large Group Reservations</h5>
                <p class="text-muted mb-0">Applies to reservations with 6 or more guests</p>
              </div>
              <button class="btn btn-warning action-btn" id="markLargeBtn">
                <i class="fas fa-users me-2"></i>Mark Large Groups
              </button>
            </div>

            <div id="bulkResult" class="mt-3"></div>
          </div>
        </div>
      </div>

      <!-- MongoDB Operations Info -->
      <div class="row">
        <div class="col-md-6">
          <div class="admin-card p-4 h-100">
            <h4><i class="fas fa-database me-2 text-primary"></i>Aggregation Pipeline</h4>
            <p class="text-muted">Used in Statistics endpoint:</p>
            <pre class="bg-light p-3 rounded"><code>aggregate([
  {
    $group: {
      _id: "$date",
      totalReservations: { $sum: 1 },
      totalGuests: { $sum: "$guests" }
    }
  },
  { $sort: { _id: 1 } }
])</code></pre>
            <p class="small text-muted mb-0">
              <i class="fas fa-lightbulb me-1"></i>
              Groups reservations by date and calculates daily totals
            </p>
          </div>
        </div>

        <div class="col-md-6">
          <div class="admin-card p-4 h-100">
            <h4><i class="fas fa-cogs me-2 text-warning"></i>Bulk Update Query</h4>
            <p class="text-muted">Used in Mark Large Groups:</p>
            <pre class="bg-light p-3 rounded"><code>updateMany(
  { guests: { $gte: 6 } },
  { 
    $set: { 
      specialRequests: "Large group" 
    } 
  }
)</code></pre>
            <p class="small text-muted mb-0">
              <i class="fas fa-lightbulb me-1"></i>
              Updates multiple documents matching the filter criteria
            </p>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Admin Login</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label>Email</label>
              <input type="email" id="loginEmail" class="form-control" required>
            </div>
            <div class="mb-3">
              <label>Password</label>
              <input type="password" id="loginPassword" class="form-control" required>
            </div>
            <button class="btn btn-warning w-100">Login</button>
            <p id="loginMsg" class="mt-2 text-center"></p>
          </form>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer-custom py-4 mt-5">
    <div class="container d-flex flex-wrap justify-content-between align-items-center">
      <div class="footer-links mb-3 mb-md-0">
        <ul class="list-unstyled">
          <li><a href="about.html">About Us</a></li>
          <li><a href="contact.html">Our Contacts</a></li>
          <li><a href="menu.html">Menu</a></li>
        </ul>
      </div>
      <div class="footer-social mb-3 mb-md-0">
        <p>¬© 2025 Taste-Mart. All rights reserved.</p>
      </div>
      <div class="footer-logos d-flex align-items-center">
        <img src="images/logo.png" alt="Logo" height="40" class="me-3">
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/auth.js"></script>

  <script>
    const STATS_API = "http://localhost:3000/api/reservations/stats/summary";
    const BULK_API = "http://localhost:3000/api/reservations/bulk/large";

    // ===== LOAD STATISTICS =====
    document.getElementById('loadStatsBtn').addEventListener('click', async () => {
      const btn = document.getElementById('loadStatsBtn');
      const container = document.getElementById('statsContainer');
      const token = localStorage.getItem('token');

      if (!token) {
        container.innerHTML = `
          <div class="alert alert-warning">
            <i class="fas fa-lock me-2"></i>
            Please login as admin to view statistics.
          </div>
        `;
        return;
      }

      // Show loading
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';

      try {
        const res = await fetch(STATS_API, {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!res.ok) {
          throw new Error('Failed to load statistics');
        }

        const stats = await res.json();

        if (stats.length === 0) {
          container.innerHTML = `
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              No reservation data available yet.
            </div>
          `;
        } else {
          // Display stats
          let html = '<div class="row">';
          
          stats.forEach(stat => {
            html += `
              <div class="col-md-4 mb-3">
                <div class="stat-box">
                  <h3>${stat.totalReservations}</h3>
                  <p><i class="fas fa-calendar-alt me-2"></i>Reservations on ${stat._id}</p>
                  <hr style="opacity: 0.3;">
                  <h3>${stat.totalGuests}</h3>
                  <p><i class="fas fa-users me-2"></i>Total Guests</p>
                </div>
              </div>
            `;
          });

          html += '</div>';

          // Add summary
          const totalRes = stats.reduce((sum, s) => sum + s.totalReservations, 0);
          const totalGuests = stats.reduce((sum, s) => sum + s.totalGuests, 0);

          html += `
            <div class="alert alert-success mt-3">
              <i class="fas fa-check-circle me-2"></i>
              <strong>Summary:</strong> ${totalRes} total reservations, ${totalGuests} total guests
            </div>
          `;

          container.innerHTML = html;
        }

        btn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Refresh Statistics';
      } catch (err) {
        console.error(err);
        container.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Error loading statistics: ${err.message}
          </div>
        `;
        btn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Try Again';
      } finally {
        btn.disabled = false;
      }
    });

    // ===== MARK LARGE GROUPS =====
    document.getElementById('markLargeBtn').addEventListener('click', async () => {
      const btn = document.getElementById('markLargeBtn');
      const resultDiv = document.getElementById('bulkResult');
      const token = localStorage.getItem('token');

      if (!token) {
        resultDiv.innerHTML = `
          <div class="alert alert-warning">
            <i class="fas fa-lock me-2"></i>
            Please login as admin to perform bulk operations.
          </div>
        `;
        return;
      }

      if (!confirm('Mark all reservations with 6+ guests as "Large group reservation"?')) {
        return;
      }

      // Show loading
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

      try {
        const res = await fetch(BULK_API, {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!res.ok) {
          throw new Error('Bulk update failed');
        }

        const result = await res.json();

        resultDiv.innerHTML = `
          <div class="alert alert-success">
            <i class="fas fa-check-circle me-2"></i>
            <strong>Bulk Update Successful!</strong><br>
            <ul class="mb-0 mt-2">
              <li>Matched: ${result.matchedCount} reservations</li>
              <li>Modified: ${result.modifiedCount} reservations</li>
            </ul>
          </div>
        `;

        btn.innerHTML = '<i class="fas fa-users me-2"></i>Mark Large Groups';
      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Error: ${err.message}
          </div>
        `;
        btn.innerHTML = '<i class="fas fa-users me-2"></i>Try Again';
      } finally {
        btn.disabled = false;
      }
    });

    // ===== THEME TOGGLE =====
    (function() {
      const THEME_KEY = 'tasteMartTheme';
      const body = document.body;
      const toggle = document.getElementById('themeToggle');

      const saved = localStorage.getItem(THEME_KEY);
      if (saved === 'dark') {
        body.classList.add('dark-mode');
        if (toggle) toggle.innerHTML = '‚òÄÔ∏è';
      } else {
        body.classList.remove('dark-mode');
        if (toggle) toggle.innerHTML = 'üåô';
      }

      if (toggle) {
        toggle.addEventListener('click', function(e) {
          e.preventDefault();
          const isDark = body.classList.toggle('dark-mode');
          toggle.innerHTML = isDark ? '‚òÄÔ∏è' : 'üåô';
          localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
        });
      }
    })();
  </script>
</body>
</html>
